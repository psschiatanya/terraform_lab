trigger:
  branches:
    include:
      - main  # Run the pipeline on changes to the main branch

# Pipeline Variables
variables:
  terraformVersion: '1.5.3'                     # Specify the desired Terraform version
  azureServiceConnection: 'azure_connection'  # Replace with your Azure DevOps service connection name
  tfWorkingDirectory: './terraform'             # Directory where your Terraform code resides (update if needed)

# Pool definition
pool:
  vmImage: 'ubuntu-latest'

steps:
  # Step 1: Install Terraform
   - script: |
      curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      sudo apt-get update && sudo apt-get install -y jq
      curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
      sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
      sudo apt-get update && sudo apt-get install terraform
     displayName: 'Install Terraform'

  # Step 2: Terraform Init
   - task: TerraformCLI@0
     displayName: 'Terraform Init'
     inputs:
        command: 'init'
        workingDirectory: $(tfWorkingDirectory)
        environmentServiceName: $(azureServiceConnection)

  # Step 3: Terraform Plan
   - task: TerraformCLI@0
     displayName: 'Terraform Plan'
     inputs:
        command: 'Plan'
        workingDirectory: $(tfWorkingDirectory)
        environmentServiceName: $(azureServiceConnection)
        
  # Step 4: Terraform Apply
   - task: TerraformCLI@0
     displayName: 'Terraform Apply'
     inputs:
        command: 'Apply'
        workingDirectory: $(tfWorkingDirectory)
        environmentServiceName: $(azureServiceConnection)
        commandOptions: '-auto-approve'  # Skips the confirmation prompt

