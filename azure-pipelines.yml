# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

variables:
  terraformVersion: '1.0.11'  # Adjust version as needed

stages:
- stage: Terraform_Stage
  displayName: "Terraform Deployment Pipeline"
  jobs:
    - job: Terraform_Job
      displayName: "Run Terraform"
      pool:
        vmImage: 'ubuntu-latest'  # Use an image with Terraform support

      steps:
      - task: ms-devlabs.custom-terraform-tasks.custom-terraform-installer-task.TerraformInstaller@0
        displayName: "Install Terraform"
        inputs:
          terraformVersion: $(terraformVersion)

      - script: terraform init
        displayName: "Terraform Init"
        workingDirectory: $(System.DefaultWorkingDirectory)

      - script: terraform plan -out=tfplan
        displayName: "Terraform Plan"
        workingDirectory: $(System.DefaultWorkingDirectory)

      - script: terraform apply -auto-approve tfplan
        displayName: "Terraform Apply"
        workingDirectory: $(System.DefaultWorkingDirectory)
        condition: eq(variables['Build.SourceBranch'], 'refs/heads/main')  # Applies only on main branch



